(async () => {
  console.log("ğŸš€ è‡ªå‹•å…¨ãƒšãƒ¼ã‚¸å‡¦ç†ï¼‹ç™»éŒ²é–‹å§‹");

  // --- è¨­å®š ---
  const CHECKBOX_ID = "ctl00_cplPageContent_AllCheck";
  const PAGE_LINK_SELECTOR = "a[id^='ctl00_cplPageContent_rptHeadPager_'][id*='lbnHeadPageNumber']";
  const REGISTER_BTN_ID = "ctl00_cplPageContent_RegisterBtn";
  const TITLE_FIELD_ID = "ctl00_cplPageContent_txtTitle";
  const START_FIELD_ID = "ctl00_cplPageContent_txtStartDate";
  const END_FIELD_ID = "ctl00_cplPageContent_txtEndDate";
  const CREATE_BTN_ID = "ctl00_cplPageContent_CreateUnitBtn";

  // --- æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆé–¢æ•° ---
  const today = new Date();
  const yyyy = today.getFullYear();
  const mm = String(today.getMonth() + 1).padStart(2, "0");
  const dd = String(today.getDate()).padStart(2, "0");
  const todayStr = `${yyyy}/${mm}/${dd}`;

  // --- DOMæ›´æ–°å¾…æ©Ÿé–¢æ•° ---
  const waitForPageUpdate = () => new Promise(resolve => {
    const observer = new MutationObserver((mutations, obs) => {
      const newCheckbox = document.getElementById(CHECKBOX_ID);
      if (newCheckbox) {
        obs.disconnect();
        resolve();
      }
    });
    observer.observe(document.body, { childList: true, subtree: true });
  });

  // --- å…¨é¸æŠ ---
  const selectAll = () => {
    const checkbox = document.getElementById(CHECKBOX_ID);
    if (checkbox) {
      checkbox.checked = true;
      checkbox.dispatchEvent(new Event("change", { bubbles: true }));
      console.log("âœ” å…¨é¸æŠå®Ÿè¡Œ");
    } else {
      console.warn("âš  ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚");
    }
  };

  // --- ãƒšãƒ¼ã‚¸ãƒªãƒ³ã‚¯å–å¾— ---
  const getPageLinks = () =>
    Array.from(document.querySelectorAll(PAGE_LINK_SELECTOR))
      .filter(a => a.textContent.trim().match(/^\d+$/));

  // --- ãƒšãƒ¼ã‚¸å·¡å› ---
  let page = 1;
  selectAll();

  while (true) {
    const links = getPageLinks();
    const nextLink = links.find(a => Number(a.textContent.trim()) === page + 1);

    if (!nextLink) {
      console.log("âœ… æœ€å¾Œã®ãƒšãƒ¼ã‚¸ã¾ã§åˆ°é”ã€‚ãƒªã‚¹ãƒˆä½œæˆå‡¦ç†ã¸ã€‚");
      break;
    }

    console.log(`â¡ ãƒšãƒ¼ã‚¸${page} â†’ ${page + 1} ã¸ç§»å‹•`);
    nextLink.click();
    await waitForPageUpdate();
    page++;
    selectAll();
  }

  // --- å…¨ãƒšãƒ¼ã‚¸å‡¦ç†å¾Œï¼šè‡ªå·±å­¦ç¿’ãƒªã‚¹ãƒˆä½œæˆ ---
  const registerBtn = document.getElementById(REGISTER_BTN_ID);
  if (registerBtn) {
    console.log("ğŸŸ¦ ã€Œè‡ªå·±å­¦ç¿’ãƒªã‚¹ãƒˆä½œæˆã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯");
    registerBtn.click();
  } else {
    console.warn("âš  ã€Œè‡ªå·±å­¦ç¿’ãƒªã‚¹ãƒˆä½œæˆã€ãƒœã‚¿ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚");
    return;
  }

  // --- ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒé–‹ãã®ã‚’å¾…ã¤ ---
  await new Promise(res => setTimeout(res, 1000));

  // --- ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å…¥åŠ› ---
  const titleInput = document.getElementById(TITLE_FIELD_ID);
  const startInput = document.getElementById(START_FIELD_ID);
  const endInput = document.getElementById(END_FIELD_ID);

  if (titleInput && startInput && endInput) {
    titleInput.value = "âŒ˜ãƒ‡ãƒ¼ã‚¿ç”¨âŒ˜";
    startInput.value = todayStr;
    endInput.value = todayStr;

    ["input", "change"].forEach(ev => {
      titleInput.dispatchEvent(new Event(ev, { bubbles: true }));
      startInput.dispatchEvent(new Event(ev, { bubbles: true }));
      endInput.dispatchEvent(new Event(ev, { bubbles: true }));
    });

    console.log(`ğŸ“ å…¥åŠ›å®Œäº†ï¼šã‚¿ã‚¤ãƒˆãƒ«ï¼âŒ˜ãƒ‡ãƒ¼ã‚¿ç”¨âŒ˜ã€æ—¥ä»˜ï¼${todayStr}`);
  } else {
    console.warn("âš  å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚");
    return;
  }

  // --- ç™»éŒ²ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ ---
  const createBtn = document.getElementById(CREATE_BTN_ID);
  if (createBtn) {
    console.log("âœ… ã€Œç™»éŒ²ã™ã‚‹ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯");
    createBtn.click();
  } else {
    console.warn("âš  ã€Œç™»éŒ²ã™ã‚‹ã€ãƒœã‚¿ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚");
  }

  console.log("ğŸ‰ å…¨å‡¦ç†å®Œäº†ï¼");
})();
